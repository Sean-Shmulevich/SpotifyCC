<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Spotify Web Playback SDK</title>
</head>

<body>
    <h1>Spotify Web Playback SDK</h1>
    <div id="current-track">Loading...</div>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <button id="play-button">Play</button>
    <button id="pause-button">Pause</button>
    <form action="" onsubmit="sendMessage(event)">
        <input type="text" id="messageText" autocomplete="off" />
        <button>Send</button>
    </form>
    <p id="playback-status">Status: Paused</p>
    <ul id='messages'>
    </ul>
    <script>
        // var ws = new WebSocket("ws://localhost:7777/ws");
        let previousState = null;
        var ws = new WebSocket("wss://racer-ultimate-literally.ngrok-free.app/api/endpoint/ws");
        ws.onmessage = function (event) {
            const messages = document.getElementById('messages')
            const message = document.createElement('li')
            const content = document.createTextNode(event.data || '')
            message.appendChild(content)
            messages.appendChild(message)
        };
        function sendMessage(songId, artist, name, state) {
            let data = { id: songId, artist, name, state };
            ws.send(JSON.stringify(data));
        }
        async function fetchToken() {
            try {
                const response = await fetch("racer-ultimate-literally.ngrok-free.app/api/endpoint/token");
                // const response = await fetch('http://localhost:7777/token');
                const data = await response.json();
                if (data.token) {
                    console.log("Token received:", data.token);
                    return data.token;
                } else {
                    throw new Error('Token not available');
                }
            } catch (error) {
                console.error('Error fetching token:', error);
            }
        }

        async function initializePlayer(token) {
            return new Promise((resolve, reject) => {

                let player;

                player = new Spotify.Player({
                    name: 'Web Playback SDK Quick Start Player',
                    getOAuthToken: cb => { cb(token); },
                    volume: 0.5,
                });

                console.log(JSON.stringify(player));

                player.addListener('ready', ({ device_id }) => {
                    //Activate the device as the currently playing spotify device.


                    console.log('Ready with Device ID', device_id);
                    resolve(player);
                });

                player.addListener('not_ready', ({ device_id }) => {
                    console.log('Device ID has gone offline', device_id);
                });


                player.addListener('initialization_error', ({ message }) => { reject(message); });
                player.addListener('authentication_error', ({ message }) => { reject(message); });
                player.addListener('account_error', ({ message }) => { reject(message); });
                player.addListener('playback_error', ({ message }) => { reject(message); });

                player.addListener('player_state_changed', state => {
                    if (state && (previousState === null || previousState.track_window.current_track.id !== state.track_window.current_track.id || previousState.paused !== state.paused)) {
                        const currentTrack = state.track_window.current_track;
                        document.getElementById('current-track').innerText = `Currently playing: ${currentTrack.name} by ${currentTrack.artists[0].name}`;
                        const playbackStatus = state.paused ? 'Paused' : 'Playing';
                        sendMessage(currentTrack.id, currentTrack.artists[0].name, currentTrack.name, playbackStatus);
                        document.getElementById('playback-status').innerText = `Status: ${playbackStatus}`;
                        previousState = state;
                    }
                });
                player.connect();
            });
        }

        function handlePlay(player) {
            player.resume().then(() => {
                console.log('Playback resumed');
            }).catch(error => {
                console.error('Error resuming playback:', error);
            });
        }

        function handlePause(player) {
            player.pause().then(() => {
                console.log('Playback paused');
            }).catch(error => {
                console.error('Error pausing playback:', error);
            });
        }

        window.onSpotifyWebPlaybackSDKReady = async () => {
            // let token = localStorage.getItem('spotifyAccessToken');

            let token = null;
            if (!token) {
                token = await fetchToken();
                if (token) {
                    localStorage.setItem('spotifyAccessToken', token);
                } else {
                    document.getElementById('current-track').innerText = "Error fetching token.";
                    return;
                }
            }

            try {
                const player = await initializePlayer(token);

                // const getPlayerOptions = {
                //     method: 'GET',
                //     headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }
                // }

                // fetch("https://api.spotify.com/v1/me/player/devices", getPlayerOptions)
                //     .then(response => response.json())
                //     .then(response => { console.log(response); })
                //     .catch(err => console.error(err));

                console.log('Initialized new player.');
            } catch (error) {
                console.error('Error initializing player:', error);
                document.getElementById('current-track').innerText = "Error initializing player.";
            }
        };
    </script>
</body>

</html>